<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Progress Note (SOAP) - Thumbnails & Sarabun Font</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.ckeditor.com/ckeditor5/41.4.2/classic/ckeditor.js"></script>

    <style>
        /* Base Styles: ใช้ Sarabun */
        html, body {
            height: 100%;
            margin: 0;
            font-family: 'Sarabun', 'Inter', 'Segoe UI', Roboto, sans-serif; 
            background-color: #f7f9fc;
            color: #333;
            font-size: 15px; 
            overflow: hidden; 
        }
        
        .header { background-color: white; padding: 10px 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; align-items: center; border-bottom: 1px solid #e6e9ef; }
        .header h1 { margin: 0; font-size: 1.4em; color: #1e3a8a; font-weight: 600; }
        .template-controls { display: flex; gap: 8px; margin-left: 20px; }
        .template-controls select, .template-controls button, .search-diagnosis input { padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 0.9em; background-color: white; }
        
        .main-container {
            display: flex;
            height: calc(100vh - 54px);
            padding: 20px;
            box-sizing: border-box;
            max-width: 1400px;
            margin: auto;
        }

        /* Layout 50:50 */
        .soap-form-container { flex: 2; display: flex; flex-direction: column; gap: 10px; padding: 20px; background-color: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-right: 20px; overflow-y: hidden; }
        .history-container { flex: 2; padding: 0 20px; overflow-y: scroll; background-color: transparent; }
        
        /* Dynamic Height */
        .soap-section { display: flex; flex-direction: column; flex-grow: 1; min-height: 0; }
        #note-area { flex-grow: 0.5; min-height: 0; }

        .soap-section label { font-weight: 600; color: #4b5563; padding: 5px 0; display: flex; justify-content: space-between; align-items: center; }
        
        /* Textarea / CKEditor Styling */
        .soap-section textarea, 
        .ck-editor__editable_inline { 
            flex-grow: 1; 
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            resize: none;
            font-size: 0.95em;
            background-color: #fafafa;
            overflow-y: auto !important;
            min-height: 50px; 
            font-family: 'Sarabun', sans-serif; /* ใช้ Sarabun ใน Textarea */
        }
        
        /* CKEditor Height Control */
        #assessment-area .ck-editor__main { flex-grow: 1; display: flex; flex-direction: column; min-height: 0; }
        .ck-editor__editable { flex-grow: 1; overflow-y: auto; padding: 10px; min-height: 100px; }
        #assessment-area .attach-btn { display: none; }

        /* Icons & Buttons */
        .attach-btn, .last-vital-btn { background-color: #10b981; color: white; padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 0.8em; font-weight: 600; display: flex; align-items: center; gap: 5px; }
        .last-vital-btn { background-color: #f59e0b; }
        .button-group { text-align: right; padding-top: 10px; flex-grow: 0; }
        .button-group button { padding: 10px 20px; margin-left: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; }
        .button-group .save-btn { background-color: #3b82f6; color: white; }
        .button-group .cancel-btn { background-color: #f1f5f9; color: #4b5563; }

        /* History Styles */
        .history-container h2 { margin: 0 0 15px 0; color: #1e3a8a; font-size: 1.4em; font-weight: 600; padding: 10px 0; border-bottom: 2px solid #e6e9ef; }
        .note-record { background-color: white; padding: 15px; margin-bottom: 25px; border-radius: 12px; box-shadow: 0 6px 16px rgba(0,0,0,0.08); border-left: 5px solid #d1d5db; transition: border-color 0.3s, box-shadow 0.3s; }
        .soap-history-item { padding: 4px 0; font-size: 0.9em; line-height: 1.6; }
        .soap-history-item strong { color: #1e3a8a; font-weight: 700; margin-right: 5px; }
        .soap-history-item span { white-space: pre-wrap; color: #4b5563; }

        /* *** 1. Image Thumbnail & Lightbox Styles *** */
        .soap-history-item img {
            max-width: 100px; /* กำหนดขนาด Thumbnails */
            height: auto;
            border-radius: 4px;
            margin-top: 5px;
            display: inline-block;
            cursor: pointer; /* เพื่อบ่งบอกว่าคลิกได้ */
            transition: opacity 0.2s;
            border: 1px solid #ccc;
            padding: 2px;
        }
        .soap-history-item img:hover {
            opacity: 0.8;
        }

        /* Lightbox Container (Modal) */
        .lightbox {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            padding-top: 50px; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.9); 
        }

        .lightbox-content {
            margin: auto;
            display: block;
            width: 80%;
            max-width: 900px;
            border-radius: 8px;
        }

        .lightbox-content, .caption { 
            animation-name: zoom;
            animation-duration: 0.6s;
        }

        @keyframes zoom {
            from {transform:scale(0)} 
            to {transform:scale(1)}
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
        }

        .close-btn:hover,
        .close-btn:focus {
            color: #bbb;
            text-decoration: none;
            cursor: pointer;
        }
        /* End Lightbox Styles */
    </style>
</head>
<body>

<div class="header">
    <h1>Progress Note</h1>
    <div class="template-controls">
        <select>
            <option>Select template...</option>
        </select>
        <button><i class="fa-solid fa-cloud-arrow-up"></i> Update Template</button>
    </div>
    <div class="search-diagnosis">
        <input type="text" placeholder="Search Diagnosis">
    </div>
</div>

<div class="main-container">
    
    <div class="soap-form-container">
        
        <div class="soap-section">
            <label for="subjective">S (Subjective)</label>
            <textarea id="subjective" placeholder="บันทึกอาการที่ผู้ป่วยบอก..."></textarea>
        </div>

        <div class="soap-section">
            <label for="objective">
                O (Objective)
                <button class="last-vital-btn"><i class="fa-solid fa-heart-pulse"></i> Last vital sign</button>
            </label>
            <textarea id="objective" placeholder="บันทึก V/S, Physical Exam, Lab results..."></textarea>
        </div>

        <div class="soap-section" id="assessment-area">
            <label for="assessment">
                A (Assessment)
                <button class="attach-btn" onclick="toggleAttachmentInput()"><i class="fa-solid fa-paperclip"></i> Attach Image</button>
            </label>
            <textarea id="editor" placeholder="บันทึกการประเมินปัญหา..."></textarea>
            
            <div class="attachment-input-group" id="attachment-input" style="display:none;">
                <label for="attachment-file">Choose Image File (CXR, Drawing, etc.):</label>
                <input type="file" id="attachment-file" accept="image/*">
            </div>
        </div>

        <div class="soap-section">
            <label for="plan">P (Plan)</label>
            <textarea id="plan" placeholder="บันทึกแผนการรักษา/ดูแล..."></textarea>
        </div>
        
        <div class="soap-section" id="note-area">
            <label for="note">Note</label>
            <textarea id="note" placeholder="บันทึกข้อมูลเพิ่มเติมที่ไม่ใช่ SOAP..."></textarea>
        </div>

        <div class="button-group">
            <button class="cancel-btn"><i class="fa-solid fa-xmark"></i> Cancel</button>
            <button class="save-btn" onclick="processAndSaveNote()"><i class="fa-solid fa-floppy-disk"></i> Save</button>
        </div>

    </div>

    <div class="history-container" id="history-container">
        <h2>History (Past Notes)</h2>

        <div class="note-record" ondblclick="toggleTag(this)">
            <div class="note-record-header">
                <span>26 Nov 2025 09:37 (1 day ago)</span>
                <span>นพ. พลัส</span>
            </div>
            
            <div class="soap-history-item"><strong>S:</strong> <span>Shift note. On NIV ยังมีเสมหะ...</span></div>
            <div class="soap-history-item"><strong>O:</strong> <span>T: 37.3 °C. Pulse: 88. RR: 14...</span></div>
            <div class="soap-history-item"><strong>A:</strong> <span>#History of pneumonia... R/o new infiltrate. 
                <img src="https://via.placeholder.com/500x300/0000FF/FFFFFF?text=X-Ray+Thumbnail" 
                    alt="X-Ray 26-11" 
                    onclick="openLightbox(this)">
                </span>
            </div>
            
            <div class="soap-history-item"><strong>P:</strong> <span>- Observe RS + RS support...</span></div>
            <div class="note-history-content"><strong>Note:</strong> Discussed with family regarding long term care plan.</div>
        </div>

        <div class="note-record tag-red" ondblclick="toggleTag(this)">
            <div class="note-record-header">
                <span>25 Nov 2025 18:40 (2 days ago)</span>
                <span>นพ. กัญจน์</span>
            </div>
            
            <div class="soap-history-item"><strong>S:</strong> <span>Off NIV on O2 cannula low flow...</span></div>
            <div class="soap-history-item"><strong>O:</strong> <span>Respiratory Rate: 14. BP: 132/103. SpO2 95% on O2 cannula.</span></div>
            <div class="soap-history-item"><strong>A:</strong> <span>R/o impending recurrent RS failure...</span></div>
            <div class="soap-history-item"><strong>P:</strong> <span>- Observe RS + RS support...</span></div>
        </div>
    </div>
</div>

<div id="myLightbox" class="lightbox" onclick="closeLightbox()">
    <span class="close-btn" onclick="closeLightbox()">&times;</span>
    <img class="lightbox-content" id="lightboxImage">
</div>
<script>
    let editorInstance; 

    // CKEditor Custom Upload Adapter (Base64) - ใช้เพื่อให้รูปภาพจาก CKEditor ถูกแทรกเป็น Base64
    class MyUploadAdapter {
        constructor( loader ) { this.loader = loader; }
        upload() {
            return this.loader.file
                .then( file => new Promise( ( resolve, reject ) => {
                    const reader = new FileReader();
                    reader.onload = function(e) { resolve( { default: e.target.result } ); };
                    reader.onerror = function() { reject( 'Could not read the file.' ); };
                    reader.readAsDataURL( file );
                } ) );
        }
        abort() {}
    }

    function MyCustomUploadAdapterPlugin( editor ) {
        editor.plugins.get( 'FileRepository' ).createUploadAdapter = ( loader ) => {
            return new MyUploadAdapter( loader );
        };
    }
    

    // เริ่มต้น CKEditor 
    ClassicEditor
        .create( document.querySelector( '#editor' ), {
            toolbar: {
                items: [
                    'bold', 'italic', 'underline', '|', 
                    'bulletedList', 'numberedList', '|',
                    'uploadImage',
                    'undo', 'redo'
                ]
            },
            extraPlugins: [ MyCustomUploadAdapterPlugin ],
            image: {
                toolbar: [ 'imageTextAlternative', '|', 'imageStyle:alignLeft', 'imageStyle:alignCenter', 'imageStyle:alignRight' ],
                styles: [ 'alignLeft', 'alignCenter', 'alignRight' ]
            },
            placeholder: 'บันทึกการประเมินปัญหา...',
        } )
        .then( editor => {
            console.log( 'CKEditor 5 is ready.', editor );
            editorInstance = editor; 
        } )
        .catch( error => {
            console.error( error );
        } );

    // *** 1. Lightbox Functions ***
    function openLightbox(element) {
        const lightbox = document.getElementById("myLightbox");
        const lightboxImg = document.getElementById("lightboxImage");
        lightbox.style.display = "block";
        lightboxImg.src = element.src;
    }

    function closeLightbox() {
        const lightbox = document.getElementById("myLightbox");
        lightbox.style.display = "none";
    }
    // *** End Lightbox Functions ***

    function toggleAttachmentInput() {
        alert("กรุณาใช้ปุ่ม 'Upload Image' ในแถบเครื่องมือของ Assessment แทนการ Attach File แยก");
    }

    function toggleTag(element) {
        if (element.classList.contains('tag-yellow')) {
            element.classList.remove('tag-yellow');
            element.classList.add('tag-red');
        } else if (element.classList.contains('tag-red')) {
            element.classList.remove('tag-red');
        } else {
            element.classList.add('tag-yellow');
        }
    }
    
    function processAndSaveNote() {
        saveNote(null, null); 
    }

    // ฟังก์ชันจำลองการ Save และแสดงผลข้อมูลจริง
    function saveNote(attachmentDataUrl, fileName) {
        const s = document.getElementById('subjective').value.trim() || "N/A";
        const o = document.getElementById('objective').value.trim() || "N/A";
        
        let a = "N/A";
        if (editorInstance) {
            a = editorInstance.getData().trim();
        } else {
            a = document.getElementById('editor').value.trim();
        }
        
        const p = document.getElementById('plan').value.trim() || "N/A";
        const note = document.getElementById('note').value.trim();
        
        const timestamp = new Date().toLocaleString('th-TH', { 
            day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' 
        }).replace(/(\d{4})/, '$1').replace(',', '');
        
        let attachmentHtml = ''; 
        let noteHtml = '';

        if (note && note !== 'N/A') {
            noteHtml = `
                <div class="note-history-content">
                    <strong>Note:</strong> <span>${note}</span>
                </div>
            `;
        }
        
        const assessmentContent = (a === "N/A" || a === "") ? "<span>N/A</span>" : a; 

        // 1. เพิ่ม onclick="openLightbox(this)" เข้าไปในแท็ก <img> ที่ถูกสร้างโดย CKEditor
        // ต้องใช้ Regular Expression ในการหาแท็ก <img> เพื่อเพิ่ม onclick event
        const processedAssessmentContent = assessmentContent.replace(/<img(.*?)src="(.*?)"(.*?)>/gi, (match, p1, src, p3) => {
            // ตรวจสอบว่ามี onclick แล้วหรือไม่ ถ้ามีจะไม่เพิ่มซ้ำ
            if (match.toLowerCase().includes('onclick=')) {
                return match;
            }
            // เพิ่ม onclick="openLightbox(this)" และ class 'thumbnail'
            return `<img${p1}src="${src}"${p3} onclick="openLightbox(this)">`;
        });
        
        // 2. Wrap เนื้อหา A ให้อยู่ใน tag <span> เพื่อให้ใช้ CSS class soap-history-item ได้
        const finalAssessmentContent = `<span class="assessment-content-display">${processedAssessmentContent}</span>`;


        const newNoteHtml = `
            <div class="note-record" style="border-left: 5px solid #10b981; background-color: #f0fdf4; box-shadow: 0 6px 16px rgba(16, 185, 129, 0.2);" ondblclick="toggleTag(this)">
                <div class="note-record-header" style="color: #059669; border-bottom: 1px dashed #c6f6d5;">
                    <span>${timestamp} (Just Saved)</span>
                    <span>นพ. อัจฉริยะ (You)</span>
                </div>
                <div class="soap-history-item"><strong>S:</strong> <span>${s}</span></div>
                <div class="soap-history-item"><strong>O:</strong> <span>${o}</span></div>
                
                <div class="soap-history-item"><strong>A:</strong> ${finalAssessmentContent}</div>
                
                ${attachmentHtml}
                <div class="soap-history-item"><strong>P:</strong> <span>${p}</span></div>
                ${noteHtml}
            </div>
        `;

        const historyContainer = document.getElementById('history-container');
        historyContainer.insertAdjacentHTML('afterbegin', newNoteHtml);
        
        // Clear form
        document.getElementById('subjective').value = '';
        document.getElementById('objective').value = '';
        if (editorInstance) editorInstance.setData(''); 
        document.getElementById('plan').value = '';
        document.getElementById('note').value = '';
        
        historyContainer.scrollTop = 0;
        
        alert("บันทึก Progress Note เรียบร้อยแล้ว!");
    }
</script>

</body>
</html>