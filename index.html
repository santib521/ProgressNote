<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>Progress Note (SOAP) - Global Dictate & Template</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Sukhumvit+Set:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.ckeditor.com/ckeditor5/41.4.2/classic/ckeditor.js"></script>

    <style>
        /* ==================================== */
        /* BASE & LAYOUT STYLES        */
        /* ==================================== */
        html, body {
            height: 100%;
            margin: 0;
            font-family: 'Sukhumvit Set', sans-serif; 
            background-color: #f7f9fc;
            color: #333;
            font-size: 15px; 
            overflow: hidden; 
        }
        
        .header { 
            background-color: white; 
            padding: 10px 20px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
            display: flex; 
            align-items: center; 
            border-bottom: 1px solid #e6e9ef; 
            gap: 15px; 
        }
        .header h1 { margin: 0; font-size: 1.5em; color: #1e3a8a; }
        .header .template-controls { display: flex; gap: 10px; align-items: center; margin-left: auto; }
        
        .header select { 
            padding: 8px 12px; 
            border: 1px solid #ccc; 
            border-radius: 6px; 
            font-family: 'Sukhumvit Set', sans-serif; 
            background-color: white;
            font-size: 0.95em;
        }

        .main-container {
            display: flex;
            height: calc(100vh - 54px); 
            padding: 20px;
            box-sizing: border-box;
            max-width: 1400px;
            margin: auto;
        }

        /* Form Container (Left Side) */
        .soap-form-container {
            flex: 2; 
            display: flex;
            flex-direction: column;
            gap: 10px; 
            padding: 20px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin-right: 20px;
            
            max-height: 100%; 
            box-sizing: border-box; 
            overflow-y: auto; 
            min-height: 0;
        }
        
        /* History Wrapper - ‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏Ñ‡πà‡∏ï‡∏±‡∏ß‡∏à‡∏±‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏ï‡∏±‡∏ß Scroll */
        .history-wrapper {
            flex: 2;
            padding: 0 20px;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        /* History Header - ‡∏ñ‡∏π‡∏Å‡∏ï‡∏£‡∏∂‡∏á‡πÑ‡∏ß‡πâ */
        .history-wrapper h2 { 
            margin: 0 0 15px 0; 
            color: #1e3a8a; 
            font-size: 1.4em; 
            font-weight: 600; 
            padding: 10px 0; 
            border-bottom: 2px solid #e6e9ef;
            flex-shrink: 0; 
        }
        
        /* History Controls & Search Input */
        .history-controls {
            margin-bottom: 10px;
            flex-shrink: 0;
            display: flex; 
            gap: 10px;    
            align-items: center;
        }
        #diagnosis-search-input {
            flex-grow: 1; 
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            font-family: 'Sukhumvit Set', sans-serif;
            font-size: 1em;
        }
        #doctor-filter-select { 
            width: 150px; 
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 8px;
            font-family: 'Sukhumvit Set', sans-serif;
            font-size: 1em;
            flex-shrink: 0; 
            background-color: white;
        }
        
        /* New Switch for Image Only */
        .image-only-switch-container {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.95em;
            font-weight: 600;
            color: #4b5563;
            flex-shrink: 0;
        }
        #image-only-switch {
            width: 18px; 
            height: 18px;
            cursor: pointer;
            border: 1px solid #ccc;
            border-radius: 4px;
        }


        /* Date Filter Bar Style */
        .date-filter-bar {
            padding: 8px 0;
            margin-bottom: 15px;
            border-bottom: 1px solid #e6e9ef;
            border-top: 1px solid #e6e9ef;
            display: flex;
            gap: 8px;
            overflow-x: auto; 
            flex-shrink: 0;
        }
        .date-filter-bar button {
            background-color: #f1f5f9;
            color: #4b5563;
            padding: 6px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
            transition: background-color 0.2s, border-color 0.2s;
            flex-shrink: 0; 
        }
        .date-filter-bar button:hover {
            background-color: #e2e8f0;
        }
        .date-filter-bar button.active {
            background-color: #1e3a8a; 
            color: white;
            border-color: #1e3a8a;
            font-weight: 600;
        }

        /* History Content - ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß Scroll ‡∏à‡∏£‡∏¥‡∏á */
        .history-container {
            overflow-y: scroll; 
            padding-right: 15px; 
            flex-grow: 1;
            min-height: 0;
        }
        
        /* ==================================== */
        /* FORM (SOAP) CONTROL STYLES     */
        /* ==================================== */
        .soap-section { 
            display: flex; 
            flex-direction: column; 
            min-height: 0; 
            margin-bottom: 10px;
            padding-bottom: 0px;
            
            flex: none; 
            height: auto; 
        }

        #subjective-area, #objective-area, #plan-area {
            min-height: 120px; 
        }
        
        #note-area {
            min-height: 80px; 
        }

        #assessment-area {
            min-height: auto; 
        }
        
        .soap-section textarea, 
        .ck-editor__editable_inline { 
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            resize: none;
            font-size: 0.95em;
            background-color: #fafafa;
            overflow-y: auto !important; 
            font-family: 'Sukhumvit Set', sans-serif;
            flex-grow: 1; 
        }
        
        #assessment-area .ck-editor__main {
            flex-grow: 1; 
            display: flex;
            flex-direction: column;
            min-height: 0;
            height: auto; 
        }
        
        .ck-editor__editable {
            flex-grow: 1; 
            overflow-y: auto !important; 
            min-height: 50px; 
        }
        
        .ck-editor__editable_inline img {
            max-width: 640px !important; 
            height: auto;
            display: block; 
            float: none !important; 
            margin: 10px auto; 
            border: 1px solid #1e3a8a;
            padding: 2px;
            border-radius: 4px;
        }

        .button-group { 
            text-align: right; 
            padding-top: 10px; 
            flex-shrink: 0; 
            margin-top: 5px; 
        }
        
        /* ==================================== */
        /* New STYLES for Speech-to-Text */
        /* ==================================== */
        .soap-section label { 
            font-weight: 600; 
            color: #4b5563; 
            padding: 5px 0; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        .speech-to-text-btn {
            background-color: #3b82f6; /* Global Dictate Color */
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8em;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.2s, box-shadow 0.2s;
            flex-shrink: 0;
        }
        .speech-to-text-btn:hover {
            background-color: #2563eb; 
        }
        .speech-to-text-btn.active {
            background-color: #1d4ed8; /* Darker blue when recording */
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
        
        /* ==================================== */
        /* HISTORY STYLES & ADD BUTTON */
        /* ==================================== */
        
        .note-record { 
            background-color: white; 
            padding: 15px; 
            margin-bottom: 25px; 
            border-radius: 12px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.05); 
            border-left: 5px solid #d1d5db; 
            transition: border-color 0.3s, box-shadow 0.3s; 
        }
        /* Combined visibility control for all filters (Added hidden-by-image) */
        .note-record.hidden-by-filter, 
        .note-record.hidden-by-date, 
        .note-record.hidden-by-doctor,
        .note-record.hidden-by-image { 
            display: none; 
        }

        .soap-history-item { padding: 4px 0; font-size: 0.9em; line-height: 1.6; }
        .soap-history-item strong { color: #1e3a8a; font-weight: 700; margin-right: 5px; }
        .soap-history-item span { white-space: pre-wrap; color: #4b5563; }

        /* HEADER & BUTTON LAYOUT */
        .note-record-header {
            display: flex;
            justify-content: space-between; 
            align-items: center;
            border-bottom: 1px dashed #e6e9ef;
            padding-bottom: 5px;
            margin-bottom: 10px;
        }
        .note-record-header .add-to-form-btn {
            order: -1; 
            flex-shrink: 0;
        }
        .note-record-header span:first-of-type {
            order: 0; 
            flex-grow: 1; 
            text-align: center; 
            font-size: 0.95em; 
            font-weight: 600; 
            color: #333; 
        }
        .note-record-header span:last-of-type {
            order: 1; 
            flex-shrink: 0;
            font-weight: 600;
            color: #4b5563;
            margin-left: 10px;
        }

        /* ‡∏õ‡∏∏‡πà‡∏° Add */
        .add-to-form-btn {
            background-color: #6366f1; 
            color: white;
            padding: 5px 10px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8em;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: background-color 0.2s;
        }
        .add-to-form-btn:hover {
            background-color: #4f46e5;
        }
        
        /* Thumbnail Image Style (Crucial for History) */
        .soap-history-item .ck-content::after { 
            content: "";
            display: table;
            clear: both;
        }
        .soap-history-item .ck-content img {
            max-width: 150px !important; 
            height: auto;
            float: left !important; 
            margin: 0 10px 5px 0; 
            cursor: pointer; /* Change cursor to indicate clickability */
            border: 2px solid #ddd;
            padding: 3px;
            border-radius: 6px;
            transition: transform 0.2s;
        }

        .note-history-content { margin-top: 15px; font-size: 0.9em; color: #6b7280; padding: 10px; background-color: #fffbeb; border: 1px solid #fde68a; border-radius: 8px; }
        .note-history-content strong { color: #d97706; font-weight: 700; margin-right: 5px; }
        .note-history-content::before { content: "üìå "; color: #d97706; font-size: 1em; margin-right: 5px; }
        .tag-yellow { border-left-color: #f59e0b !important; box-shadow: 0 6px 16px rgba(245, 158, 11, 0.2) !important; }
        .tag-red { border-left-color: #ef4444 !important; box-shadow: 0 6px 16px rgba(239, 68, 68, 0.2) !important; }

        /* Highlight Style */
        .highlight {
            background-color: #fcd34d; 
            padding: 1px 2px;
            border-radius: 3px;
            font-weight: 600;
        }

        /* Modal Styles */
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 1000; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.9); 
            justify-content: center; /* Center content */
            align-items: center; /* Center content */
        }
        /* Image Modal Specific Content */
        #imageModal .modal-content { 
            margin: auto; 
            display: block; 
            width: 80%; 
            max-width: 900px; 
            max-height: 90vh; 
            object-fit: contain; 
            margin-top: 50px; 
        }
        /* Lab Modal Specific Content */
        #labModal .modal-content {
            background-color: white; 
            padding: 25px; 
            border-radius: 12px; 
            max-width: 600px;
            width: 90%; 
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        .close-btn { 
            position: absolute; 
            top: 20px; 
            right: 35px; 
            color: #f1f1f1; 
            font-size: 40px; 
            font-weight: bold; 
            transition: 0.3s; 
            z-index: 1001; /* Ensure close button is above image content */
        }
        #labModal .close-btn { 
            color: #333; /* Dark color for lab modal close button */
        }
        .close-btn:hover, .close-btn:focus { 
            color: #bbb; 
            text-decoration: none; 
            cursor: pointer; 
        }
        
        /* Misc Controls */
        #assessment-area .attach-btn { display: none; }
        
        .button-group-inline {
            display: flex;
            gap: 10px;
        }
        
        .attach-btn, .last-vital-btn, .lab-btn { 
            color: white; 
            padding: 6px 12px; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            font-size: 0.8em; 
            font-weight: 600; 
            display: flex; 
            align-items: center; 
            gap: 5px; 
            transition: background-color 0.2s;
            flex-shrink: 0;
        }
        .last-vital-btn { 
            background-color: #f59e0b; /* Orange */
        }
        .last-vital-btn:hover {
            background-color: #d97706;
        }
        .lab-btn { 
            background-color: #0d9488; /* Teal */
        }
        .lab-btn:hover {
            background-color: #0f766e;
        }


        .button-group button { padding: 10px 20px; margin-left: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; }
        .button-group .save-btn { background-color: #3b82f6; color: white; }
        .button-group .cancel-btn { background-color: #f1f5f9; color: #4b5563; }
        
    </style>
</head>
<body>

<div class="header">
    <h1>Progress Note (SOAP)</h1>
    
    <button id="global-dictate-btn" class="speech-to-text-btn" onclick="startGlobalSpeechRecognition(this)"><i class="fa-solid fa-microphone"></i> Global Dictate</button>
    
    <div class="template-controls" style="margin-left: auto;">
        <select id="template-select">
            <option value="">Select template...</option>
        </select>
        <button onclick="loadTemplate()"><i class="fa-solid fa-download"></i> Load</button>
        <button onclick="saveTemplate()"><i class="fa-solid fa-star"></i> Save as Favorite</button>
        <button><i class="fa-solid fa-cloud-arrow-up"></i> Update Template</button> 
    </div>
</div>

<div class="main-container">
    
    <div class="soap-form-container">
        
        <div class="soap-section" id="subjective-area">
            <label for="subjective">S (Subjective)</label>
            <textarea id="subjective" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ö‡∏≠‡∏Å..."></textarea>
        </div>

        <div class="soap-section" id="objective-area">
            <label for="objective">
                O (Objective)
                <span class="button-group-inline">
                    <button class="last-vital-btn" onclick="insertVitalSign()"><i class="fa-solid fa-heart-pulse"></i> Last vital sign</button>
                    <button class="lab-btn" onclick="showLabModal()"><i class="fa-solid fa-flask-vial"></i> Lab</button>
                </span>
            </label>
            <textarea id="objective" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å V/S, Physical Exam, Lab results..."></textarea>
        </div>

        <div class="soap-section" id="assessment-area">
            <label for="editor">
                A (Assessment)
                 <span class="button-group-inline">
                    <button class="attach-btn" onclick="toggleAttachmentInput()"><i class="fa-solid fa-paperclip"></i> Attach Image</button>
                </span>
            </label>
            <textarea id="editor" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤..."></textarea>
            
            <div class="attachment-input-group" id="attachment-input" style="display:none;">
                <label for="attachment-file">Choose Image File (CXR, Drawing, etc.):</label>
                <input type="file" id="attachment-file" accept="image/*">
            </div>
        </div>

        <div class="soap-section" id="plan-area">
             <label for="plan">P (Plan)</label>
            <textarea id="plan" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏Å‡∏©‡∏≤/‡∏î‡∏π‡πÅ‡∏•..."></textarea>
        </div>
        
        <div class="soap-section" id="note-area">
             <label for="note">Note</label>
            <textarea id="note" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà SOAP..."></textarea>
        </div>

        <div class="button-group">
            <button class="cancel-btn"><i class="fa-solid fa-xmark"></i> Cancel</button>
            <button class="save-btn" onclick="processAndSaveNote()"><i class="fa-solid fa-floppy-disk"></i> Save</button>
        </div>

    </div>
    
    <div class="history-wrapper">
        <h2 id="history-header">History (Past Notes)</h2>

        <div class="history-controls">
            <input type="text" id="diagnosis-search-input" placeholder="Search Diagnosis (Filter & Highlight)">
            <select id="doctor-filter-select">
                <option value="all">All Doctors</option>
            </select>
            <div class="image-only-switch-container">
                <input type="checkbox" id="image-only-switch" onclick="toggleImageOnlyFilter()">
                <label for="image-only-switch">üñºÔ∏è Show Image Only</label>
            </div>
        </div>

        <div class="date-filter-bar" id="date-filter-bar">
        </div>

        <div class="history-container" id="history-container">
            <div class="note-record" data-date="2025-11-27" data-full-date="2025-11-27T21:49" ondblclick="toggleTag(this)">
                <div class="note-record-header">
                    <button class="add-to-form-btn" onclick="copyToForm(this.closest('.note-record'))">
                        <i class="fa-solid fa-arrow-left"></i> Add
                    </button>
                    <span>27 ‡∏û.‡∏¢. 2568 21:49 (Just Saved)</span>
                    <span>‡∏ô‡∏û. ‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞ (You)</span>
                </div>
                <div class="soap-history-item" data-section="subjective" data-text='{"value":"Off NIV on O2 cannula low flow..."}' data-original-text='{"value":"Off NIV on O2 cannula low flow..."}'><strong>S:</strong> <span>Off NIV on O2 cannula low flow...</span></div>
                <div class="soap-history-item" data-section="objective" data-text='{"value":"Respiratory Rate: 14. BP: 132/103. SpO2 95% on O2 cannula."}' data-original-text='{"value":"Respiratory Rate: 14. BP: 132/103. SpO2 95% on O2 cannula."}'><strong>O:</strong> <span>Respiratory Rate: 14. BP: 132/103. SpO2 95% on O2 cannula.</span></div>
                <div class="soap-history-item" data-section="assessment" data-text='{"value":"R/o impending recurrent RS failure..."}' data-html='{"value":"R/o impending recurrent RS failure..."}' data-original-text='{"value":"R/o impending recurrent RS failure..."}' data-original-html='{"value":"R/o impending recurrent RS failure..."}'><strong>A:</strong> <span>R/o impending recurrent RS failure...</span></div>
                <div class="soap-history-item" data-section="plan" data-text='{"value":"- Observe RS + RS support..."}' data-original-text='{"value":"- Observe RS + RS support..."}'><strong>P:</strong> <span>- Observe RS + RS support...</span></div>
                <div class="note-history-content" data-section="note" data-text='{"value":"Note for 27 Nov 2568"}' data-original-text='{"value":"Note for 27 Nov 2568"}'>
                    <strong>Note:</strong> <span>Note for 27 Nov 2568</span> 
                </div>
            </div>

            <div class="note-record" data-date="2025-11-26" data-full-date="2025-11-26T09:37" ondblclick="toggleTag(this)">
                <div class="note-record-header">
                    <button class="add-to-form-btn" onclick="copyToForm(this.closest('.note-record'))">
                        <i class="fa-solid fa-arrow-left"></i> Add
                    </button>
                    <span>26 ‡∏û.‡∏¢. 2568 09:37 (1 day ago)</span>
                    <span>‡∏ô‡∏û. ‡∏û‡∏•‡∏±‡∏™</span>
                </div>
                <div class="soap-history-item" data-section="subjective" data-text='{"value":"Shift note. On NIV ‡∏¢‡∏±‡∏á‡∏°‡∏µ‡πÄ‡∏™‡∏°‡∏´‡∏∞..."}' data-original-text='{"value":"Shift note. On NIV ‡∏¢‡∏±‡∏á‡∏°‡∏µ‡πÄ‡∏™‡∏°‡∏´‡∏∞..."}'><strong>S:</strong> <span>Shift note. On NIV ‡∏¢‡∏±‡∏á‡∏°‡∏µ‡πÄ‡∏™‡∏°‡∏´‡∏∞...</span></div>
                <div class="soap-history-item" data-section="objective" data-text='{"value":"T: 37.3 ¬∞C. Pulse: 88. RR: 14. Sat: 96%"}' data-original-text='{"value":"T: 37.3 ¬∞C. Pulse: 88. RR: 14. Sat: 96%"}' ><strong>O:</strong> <span>T: 37.3 ¬∞C. Pulse: 88. RR: 14...</span></div>
                <div class="soap-history-item" data-section="assessment" 
                    data-text='{"value":"[Image: Chest X-ray attachment] R/o new infiltrate due to History of pneumonia"}' 
                    data-html='{"value":"&lt;img src=\"https://via.placeholder.com/150x100/0000FF/FFFFFF?text=Original+150x100\" data-original-src=\"https://via.placeholder.com/1280x900/0000FF/FFFFFF?text=Full+Image\" alt=\"Chest X-ray attachment\"&gt;R/o new infiltrate due to History of pneumonia"}' 
                    data-original-text='{"value":"[Image: Chest X-ray attachment] R/o new infiltrate due to History of pneumonia"}'
                    data-original-html='{"value":"&lt;img src=\"https://via.placeholder.com/150x100/0000FF/FFFFFF?text=Original+150x100\" data-original-src=\"https://via.placeholder.com/1280x900/0000FF/FFFFFF?text=Full+Image\" alt=\"Chest X-ray attachment\"&gt;R/o new infiltrate due to History of pneumonia"}'>
                    <strong>A:</strong> 
                    <div class="ck-content">
                        <img src="https://via.placeholder.com/150x100/0000FF/FFFFFF?text=Original+150x100" data-original-src="https://via.placeholder.com/1280x900/0000FF/FFFFFF?text=Full+Image" alt="Chest X-ray attachment" style="float: left;" ondblclick="handleHistoryImageClick(event)">
                        <span>R/o new infiltrate due to History of pneumonia</span>
                    </div>
                </div>
                <div class="soap-history-item" data-section="plan" data-text='{"value":"- Observe RS + RS support..."}' data-original-text='{"value":"- Observe RS + RS support..."}'><strong>P:</strong> <span>- Observe RS + RS support...</span></div>
                
                <div class="note-history-content" data-section="note" data-text='{"value":"Discussed with family regarding long term care plan."}' data-original-text='{"value":"Discussed with family regarding long term care plan."}'>
                    <strong>Note:</strong> <span>Discussed with family regarding long term care plan.</span> 
                </div>
            </div>

            <div class="note-record" data-date="2025-11-25" data-full-date="2025-11-25T18:40" ondblclick="toggleTag(this)">
                <div class="note-record-header">
                    <button class="add-to-form-btn" onclick="copyToForm(this.closest('.note-record'))">
                        <i class="fa-solid fa-arrow-left"></i> Add
                    </button>
                    <span>25 ‡∏û.‡∏¢. 2568 18:40 (2 days ago)</span>
                    <span>‡∏ô‡∏û. ‡∏Å‡∏±‡∏ç‡∏à‡∏ô‡πå</span>
                </div>
                <div class="soap-history-item" data-section="subjective" data-text='{"value":"Off NIV on O2 cannula low flow..."}' data-original-text='{"value":"Off NIV on O2 cannula low flow..."}'><strong>S:</strong> <span>Off NIV on O2 cannula low flow...</span></div>
                <div class="soap-history-item" data-section="objective" data-text='{"value":"Respiratory Rate: 14. BP: 132/103. SpO2 95% on O2 cannula."}' data-original-text='{"value":"Respiratory Rate: 14. BP: 132/103. SpO2 95% on O2 cannula."}'><strong>O:</strong> <span>Respiratory Rate: 14. BP: 132/103. SpO2 95% on O2 cannula.</span></div>
                <div class="soap-history-item" data-section="assessment" 
                    data-text='{"value":"[Image: Drawing] Patient is stable after procedure."}' 
                    data-html='{"value":"&lt;img src=\"https://via.placeholder.com/150x100/FF0000/FFFFFF?text=Drawing\" data-original-src=\"https://via.placeholder.com/1280x900/FF0000/FFFFFF?text=Full+Drawing\" alt=\"Drawing\"&gt;Patient is stable after procedure."}' 
                    data-original-text='{"value":"[Image: Drawing] Patient is stable after procedure."}'
                    data-original-html='{"value":"&lt;img src=\"https://via.placeholder.com/150x100/FF0000/FFFFFF?text=Drawing\" data-original-src=\"https://via.placeholder.com/1280x900/FF0000/FFFFFF?text=Full+Drawing\" alt=\"Drawing\"&gt;Patient is stable after procedure."}'>
                    <strong>A:</strong> 
                    <div class="ck-content">
                        <img src="https://via.placeholder.com/150x100/FF0000/FFFFFF?text=Drawing" data-original-src="https://via.placeholder.com/1280x900/FF0000/FFFFFF?text=Full+Drawing" alt="Drawing" style="float: left;" ondblclick="handleHistoryImageClick(event)">
                        <span>Patient is stable after procedure.</span>
                    </div>
                </div>
                <div class="soap-history-item" data-section="plan" data-text='{"value":"- Observe RS + RS support..."}' data-original-text='{"value":"- Observe RS + RS support..."}'><strong>P:</strong> <span>- Observe RS + RS support...</span></div>
            </div>
            
            <div class="note-record tag-yellow" data-date="2025-11-24" data-full-date="2025-11-24T12:00" ondblclick="toggleTag(this)">
                <div class="note-record-header">
                    <button class="add-to-form-btn" onclick="copyToForm(this.closest('.note-record'))">
                        <i class="fa-solid fa-arrow-left"></i> Add
                    </button>
                    <span>24 ‡∏û.‡∏¢. 2568 12:00 (3 days ago)</span>
                    <span>‡∏û‡∏ç. ‡∏ß‡∏¥‡πÑ‡∏•</span>
                </div>
                <div class="soap-history-item" data-section="subjective" data-text='{"value":"Admitted due to fever and cough."}' data-original-text='{"value":"Admitted due to fever and cough."}'><strong>S:</strong> <span>Admitted due to fever and cough.</span></div>
                <div class="soap-history-item" data-section="objective" data-text='{"value":"Initial workup complete. CXR shows LLL infiltration."}' data-original-text='{"value":"Initial workup complete. CXR shows LLL infiltration."}'><strong>O:</strong> <span>Initial workup complete. CXR shows LLL infiltration.</span></div>
                <div class="soap-history-item" data-section="assessment" data-text='{"value":"Community Acquired Pneumonia."}' data-html='{"value":"Community Acquired Pneumonia."}' data-original-text='{"value":"Community Acquired Pneumonia."}' data-original-html='{"value":"Community Acquired Pneumonia."}' ><strong>A:</strong> <span>Community Acquired Pneumonia.</span></div>
                <div class="soap-history-item" data-section="plan" data-text='{"value":"- Start Ceftriaxone 1g IV OD. - O2 support PRN."}' data-original-text='{"value":"- Start Ceftriaxone 1g IV OD. - O2 support PRN."}'><strong>P:</strong> <span>- Start Ceftriaxone 1g IV OD. - O2 support PRN.</span></div>
            </div>
            
            <div class="note-record" data-date="2025-11-26" data-full-date="2025-11-26T02:00" ondblclick="toggleTag(this)">
                <div class="note-record-header">
                    <button class="add-to-form-btn" onclick="copyToForm(this.closest('.note-record'))">
                        <i class="fa-solid fa-arrow-left"></i> Add
                    </button>
                    <span>26 ‡∏û.‡∏¢. 2568 02:00 (1 day ago)</span>
                    <span>‡∏ô‡∏û. ‡∏û‡∏•‡∏±‡∏™</span>
                </div>
                <div class="soap-history-item" data-section="subjective" data-text='{"value":"Sleepy after shift change."}' data-original-text='{"value":"Sleepy after shift change."}'><strong>S:</strong> <span>Sleepy after shift change.</span></div>
                <div class="soap-history-item" data-section="objective" data-text='{"value":"Vitals stable."}' data-original-text='{"value":"Vitals stable."}'><strong>O:</strong> <span>Vitals stable.</span></div>
                <div class="soap-history-item" data-section="assessment" data-text='{"value":"Stable."}' data-html='{"value":"Stable."}' data-original-text='{"value":"Stable."}' data-original-html='{"value":"Stable."}'><strong>A:</strong> <span>Stable.</span></div>
                <div class="soap-history-item" data-section="plan" data-text='{"value":"Continue plan."}' data-original-text='{"value":"Continue plan."}'><strong>P:</strong> <span>Continue plan.</span></div>
            </div>
            
        </div>
    </div>
</div>

<div id="imageModal" class="modal">
    <span class="close-btn" onclick="document.getElementById('imageModal').style.display='none'">&times;</span>
    <img class="modal-content" id="fullImage">
</div>

<div id="labModal" class="modal">
</div>


<script>
    let editorInstance; 
    const MAX_WIDTH = 640;
    const MAX_HEIGHT = 450;
    let activeDateFilter = null; 
    let activeDoctorFilter = null; 
    let showImageOnly = false; 
    
    // Global state for Speech Recognition
    let recognition = null; 
    let activeButton = null;

    // Mockup Data
    const mockVitalSign = `\n\n--- Last Vital Sign (27/11/2568 10:00) ---\nTemperature: 37.0 ¬∞C\nPulse: 75 /min (Regular)\nRespiratory Rate: 18 /min\nBlood Pressure: 120/80 mmHg\nSpO2: 98% (RA)\nPain Score: 0/10\n---------------------------------------------\n`;

    const mockLabs = [
        { name: "CBC", result: "WBC 10.5 (N 4-10), Hb 12.1, Plt 250k.", abnormal: false, date: "2025-11-26" },
        { name: "Electrolytes", result: "Na 135 (N 136-145), K 3.0 (N 3.5-5.0), HCO3 18 (N 22-29).", abnormal: true, date: "2025-11-27" },
        { name: "BUN/Cr", result: "BUN 30 (N 7-20), Cr 1.5 (N 0.6-1.2).", abnormal: true, date: "2025-11-27" },
        { name: "LFT", result: "AST 25, ALT 30, ALP 90, Total Bili 1.0.", abnormal: false, date: "2025-11-25" },
        { name: "Urine Analysis", result: "RBC 5-10/HPF (N <5), Protein trace.", abnormal: true, date: "2025-11-26" },
    ];
    
    // FIX 2: Template/Favorite Mock Data
    const mockTemplates = [
        { name: "Pneumonia Initial", s: "Fever, cough, SOB.", o: "Temp 38.5, CXR: infiltrate. Lab: WBC 10.5.", a: "Community Acquired Pneumonia.", p: "Start Ceftriaxone 1g IV OD. O2 support." },
        { name: "Stable Follow-up", s: "Feeling better, no new complaints.", o: "Vitals stable, PE unremarkable.", a: "Stable, improving.", p: "Continue meds. Follow up in 1 week.", note: "Discussed care plan." }
    ];

    /* ================================================= */
    /* SPEECH-TO-TEXT FUNCTION (FIX 1: Global Dictate)   */
    /* ================================================= */
    
    function startGlobalSpeechRecognition(button) {
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
            alert('‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢! ‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Speech-to-Text ‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ Google Chrome ‡∏´‡∏£‡∏∑‡∏≠ Microsoft Edge ‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î');
            return;
        }

        if (recognition && recognition.active) {
            recognition.stop();
            return; 
        }

        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        
        recognition.continuous = true; 
        recognition.interimResults = false; 
        recognition.lang = 'th-TH'; 
        recognition.active = true; 

        activeButton = button;
        
        button.classList.add('active');
        button.innerHTML = '<i class="fa-solid fa-microphone-slash"></i> Listening...';
        
        // Ensure the last modified element gets focus after transcription
        let lastTargetId = 'subjective'; 

        recognition.onstart = function() {
            console.log('Global Speech recognition started.');
        };

        recognition.onresult = function(event) {
            let finalTranscript = '';
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                if (event.results[i].isFinal) {
                    finalTranscript += event.results[i][0].transcript;
                }
            }
            
            if (finalTranscript) {
                lastTargetId = parseAndPopulateSoap(finalTranscript.trim());
            }
        };

        const resetDictationState = () => {
             if (activeButton) {
                activeButton.classList.remove('active');
                activeButton.innerHTML = '<i class="fa-solid fa-microphone"></i> Global Dictate';
            }
            if (recognition) {
                 recognition.active = false;
                 recognition = null;
            }
            // Focus on the last element written to
            document.getElementById(lastTargetId).focus();
            activeButton = null;
        }

        recognition.onerror = function(event) {
            console.error('Speech recognition error:', event.error);
            resetDictationState();
        };

        recognition.onend = function() {
            console.log('Speech recognition ended.');
            resetDictationState();
        };
        
        try {
            recognition.start();
        } catch (e) {
            console.error("Recognition already active or failed to start:", e);
            resetDictationState();
        }
    }
    
    // FIX 1: Parsing logic for S:, O:, A:, P:
    function parseAndPopulateSoap(transcript) {
        const sections = ['S', 'O', 'A', 'P', 'Note'];
        const map = { 
            'S': 'subjective', 
            'O': 'objective', 
            'A': 'editor', 
            'P': 'plan',
            'Note': 'note' 
        };
        
        // Regex to find prefixes: S:, O:, A:, P:, Note: (case-insensitive)
        const regex = new RegExp(`(${sections.join('|')}):`, 'gi');
        
        // Split the transcript by the prefixes, keeping the prefixes in the result
        let parts = transcript.split(regex).filter(part => part.trim() !== '');

        let currentTargetId = 'subjective'; // Default target if no prefix is found first

        for (let i = 0; i < parts.length; i++) {
            const part = parts[i].trim();
            
            // Check if this part is a prefix (S, O, A, P, Note)
            const prefixMatch = sections.find(s => part.toUpperCase() === s.toUpperCase());
            
            if (prefixMatch) {
                currentTargetId = map[prefixMatch];
            } else {
                // This part is the content for the currentTargetId
                const content = part.trim() + ' ';
                
                if (currentTargetId === 'editor' && editorInstance) {
                    editorInstance.model.change( writer => {
                        const textNode = writer.createText( content );
                        editorInstance.model.insertContent( textNode, editorInstance.model.document.selection.focus );
                    });
                } else {
                    const targetElement = document.getElementById(currentTargetId);
                    if (targetElement) {
                        targetElement.value += content;
                        targetElement.scrollTop = targetElement.scrollHeight; 
                    }
                }
                // If content was inserted, the next part should ideally be a new prefix
            }
        }
        
        return currentTargetId; // Return the last modified element ID
    }


    /* ================================================= */
    /* TEMPLATE/FAVORITE FUNCTIONS (FIX 2: Favorite)     */
    /* ================================================= */
    
    function populateTemplateSelect() {
        const select = document.getElementById('template-select');
        select.innerHTML = '<option value="">Select template...</option>';
        mockTemplates.forEach((template, index) => {
            select.innerHTML += `<option value="${index}">${template.name}</option>`;
        });
    }

    function loadTemplate() {
        const select = document.getElementById('template-select');
        const index = select.value;
        
        if (index === "" || index === null) {
            alert("Please select a template to load.");
            return;
        }
        
        const template = mockTemplates[parseInt(index)];
        
        document.getElementById('subjective').value = template.s || '';
        document.getElementById('objective').value = template.o || '';
        document.getElementById('plan').value = template.p || '';
        
        if (editorInstance) {
            editorInstance.setData(template.a || '');
        }
        document.getElementById('note').value = template.note || ''; 

        alert(`Template "${template.name}" loaded.`);
    }

    function saveTemplate() {
        const templateName = prompt("Enter name for the new template/favorite:");
        if (!templateName) return;

        const newTemplate = {
            name: templateName,
            s: document.getElementById('subjective').value.trim(),
            o: document.getElementById('objective').value.trim(),
            a: editorInstance ? editorInstance.getData().trim() : document.getElementById('editor').value.trim(),
            p: document.getElementById('plan').value.trim(),
            note: document.getElementById('note').value.trim()
        };
        
        mockTemplates.push(newTemplate);
        populateTemplateSelect();
        alert(`Template "${templateName}" saved as favorite.`);
    }


    /* ================================================= */
    /* LAB & VITAL SIGN FUNCTIONS (Modal is confirmed)   */
    /* ================================================= */

    function insertVitalSign() {
        const objectiveTextarea = document.getElementById('objective');
        const currentValue = objectiveTextarea.value.trim();
        
        if (currentValue.startsWith('--- Last Vital Sign')) {
            objectiveTextarea.value = mockVitalSign.trim(); 
        } else if (currentValue === '') {
            objectiveTextarea.value = mockVitalSign.trim(); 
        } else {
            objectiveTextarea.value = currentValue + '\n\n' + mockVitalSign.trim();
        }
        objectiveTextarea.focus();
        objectiveTextarea.scrollTop = objectiveTextarea.scrollHeight; 
    }

    function showLabModal() {
        const modal = document.getElementById('labModal');
        let modalContent = `
            <div class="modal-content lab-modal-content">
                <span class="close-btn" onclick="document.getElementById('labModal').style.display='none'">&times;</span>
                <h2><i class="fa-solid fa-flask-vial"></i> Current Lab Results (Mock Data)</h2>
                <p style="margin-top: -10px; margin-bottom: 10px; font-size: 0.9em; color: #4b5563;">Click on a lab result to insert into the Objective area.</p>
                <div id="lab-list" style="max-height: 400px; overflow-y: auto;">
        `;
        
        const sortedLabs = [...mockLabs].sort((a, b) => new Date(b.date) - new Date(a.date));
        
        sortedLabs.forEach(lab => {
            const abnormalTag = lab.abnormal ? ' <span style="color:#ef4444; font-weight:600;">(ABNORMAL)</span>' : '';
            const colorStyle = lab.abnormal ? 'style="border-left: 4px solid #ef4444; background-color: #fef2f2;"' : 'style="border-left: 4px solid #0d9488; background-color: #f0faf9;"';
            const labText = `${lab.name}: ${lab.result} [Date: ${lab.date}]`;

            modalContent += `
                <div ${colorStyle} 
                    style="padding: 10px; border-radius: 6px; margin-bottom: 8px; cursor: pointer; transition: background-color 0.2s, box-shadow 0.2s; font-size: 0.9em;"
                    onclick="insertLabText('${labText.replace(/'/g, "\\'")}', this.closest('.modal'));">
                    <i class="fa-solid fa-plus-circle" style="margin-right:8px; color:#10b981;"></i> 
                    <strong>${lab.name} (${lab.date}):</strong> ${lab.result}${abnormalTag}
                </div>
            `;
        });
        
        modalContent += `</div></div>`;
        
        modal.innerHTML = modalContent; 
        modal.style.display = 'flex'; // Show modal
    }

    function insertLabText(text, modalElement) {
        const objectiveTextarea = document.getElementById('objective');
        objectiveTextarea.value += '\n\n' + text.trim();
        objectiveTextarea.focus();
        objectiveTextarea.scrollTop = objectiveTextarea.scrollHeight; 
        if(modalElement) modalElement.style.display = 'none'; // Close the modal
    }
    
    /* ================================================= */
    /* HISTORY & FILTERING FUNCTIONS (Cleanup confirmed) */
    /* ================================================= */
    
    // Updated to handle JSON string stored in attribute
    const escapeForAttr = (content) => {
        const jsonString = JSON.stringify({value: content}); 
        return jsonString.replace(/'/g, "\\'"); 
    };

    function calculateTotalDays() {
        const historyRecords = document.querySelectorAll('.note-record');
        const uniqueDates = new Set();
        
        historyRecords.forEach(record => {
            const dateAttr = record.getAttribute('data-date');
            if (dateAttr) {
                uniqueDates.add(dateAttr); 
            }
        });
        
        const totalDays = uniqueDates.size;
        const headerElement = document.getElementById('history-header');
        
        if (totalDays === 0) {
            headerElement.textContent = 'History (No Notes)';
        } else {
            headerElement.textContent = `History (${totalDays} days)`;
        }
    }
    
    const formatHistoryImageHtml = (html) => {
        let formattedHtml = html.replace(/<img /g, '<img style="float: left;" ');
        formattedHtml = formattedHtml.replace(/<img (?!.*ondblclick)/g, '$& ondblclick="handleHistoryImageClick(event)"');
        return formattedHtml;
    };


    function toggleImageOnlyFilter() {
        showImageOnly = document.getElementById('image-only-switch').checked;
        applyAllFiltersAndHighlight();
    }


    function applyAllFiltersAndHighlight() {
        const query = document.getElementById('diagnosis-search-input').value.trim();
        const regex = query.length >= 1 ? new RegExp(query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi') : null;
        const historyRecords = document.querySelectorAll('.note-record');
        
        // 1. Restore original content and reset classes
        historyRecords.forEach(record => {
            record.classList.remove('hidden-by-date', 'hidden-by-doctor', 'hidden-by-filter', 'hidden-by-image'); 

            record.querySelectorAll('.soap-history-item, .note-history-content').forEach(item => {
                const isAssessment = item.getAttribute('data-section') === 'assessment';
                
                let originalContent;
                
                if (isAssessment) {
                    originalContent = JSON.parse(item.getAttribute('data-original-html') || '{"value":""}').value;
                    const sectionContentDiv = item.querySelector('.ck-content');
                    const sectionSpan = item.querySelector('span');
                    
                    if (sectionContentDiv) {
                        sectionContentDiv.innerHTML = formatHistoryImageHtml(originalContent);
                        if(sectionSpan) sectionSpan.style.display = 'none'; 
                    } else if (sectionSpan) {
                         const originalText = JSON.parse(item.getAttribute('data-original-text') || '{"value":""}').value;
                         sectionSpan.textContent = originalText;
                         sectionSpan.style.display = 'inline';
                    }
                } else {
                    originalContent = JSON.parse(item.getAttribute('data-original-text') || '{"value":""}').value;
                    const sectionSpan = item.querySelector('span');
                    if (sectionSpan) {
                         sectionSpan.innerHTML = originalContent; 
                    } 
                }
            });
        });

        // 2. Apply filters and highlighting
        historyRecords.forEach(record => {
            const recordDate = record.getAttribute('data-date');
            const doctorNameSpan = record.querySelector('.note-record-header span:last-of-type');
            const doctorName = doctorNameSpan ? doctorNameSpan.textContent.trim() : '';
            let matchFound = (regex === null); 

            // Apply Date Filter
            if (activeDateFilter !== null && recordDate !== activeDateFilter) {
                record.classList.add('hidden-by-date');
            }

            // Apply Doctor Filter
            if (activeDoctorFilter !== null && doctorName !== activeDoctorFilter) {
                record.classList.add('hidden-by-doctor');
            }
            
            // Apply Image Only Filter
            if (showImageOnly) {
                const assessmentItem = record.querySelector('.soap-history-item[data-section="assessment"]');
                let hasImage = false;
                if (assessmentItem) {
                    const assessmentHtml = JSON.parse(assessmentItem.getAttribute('data-original-html') || '{"value":""}').value;
                    if (assessmentHtml && assessmentHtml.includes('<img')) {
                        hasImage = true;
                    }
                }
                
                if (!hasImage) {
                    record.classList.add('hidden-by-image');
                }
            }


            // Apply Search/Highlight Filter only if not hidden by other filters
            if (!record.classList.contains('hidden-by-date') && 
                !record.classList.contains('hidden-by-doctor') &&
                !record.classList.contains('hidden-by-image')) {
                
                if (regex) {
                    record.querySelectorAll('.soap-history-item, .note-history-content').forEach(item => {
                        const isAssessment = item.getAttribute('data-section') === 'assessment';
                        
                        let originalContentAttr = isAssessment ? 'data-original-html' : 'data-original-text';
                        let originalContent = JSON.parse(item.getAttribute(originalContentAttr) || '{"value":""}').value;

                        if (originalContent.match(regex)) {
                            matchFound = true;
                            
                            if (isAssessment) {
                                const highlightedHtml = originalContent.replace(regex, '<span class="highlight">$&</span>');
                                const sectionContentDiv = item.querySelector('.ck-content');
                                
                                if (sectionContentDiv) {
                                    sectionContentDiv.innerHTML = formatHistoryImageHtml(highlightedHtml);
                                } else {
                                     const sectionSpan = item.querySelector('span'); 
                                     if(sectionSpan) sectionSpan.innerHTML = originalContent.replace(regex, '<span class="highlight">$&</span>');
                                }
                            } else {
                                // For S, O, P, Note: Plain text highlighting
                                const highlightedContent = originalContent.replace(regex, '<span class="highlight">$&</span>');
                                const sectionSpan = item.querySelector('span');
                                if (sectionSpan) {
                                    sectionSpan.innerHTML = highlightedContent;
                                }
                            }
                        }
                    });

                    if (!matchFound) {
                        record.classList.add('hidden-by-filter');
                    }
                } 
            }
        });
    }

    function filterHistoryByDate(dateFilter, clickedButton) {
        activeDateFilter = (dateFilter === 'all') ? null : dateFilter;
        const dateButtons = document.querySelectorAll('.date-filter-bar button');

        dateButtons.forEach(btn => btn.classList.remove('active'));
        if (clickedButton) {
            clickedButton.classList.add('active');
        }

        applyAllFiltersAndHighlight();
    }
    
    function filterHistoryByDoctor(doctorName) {
        activeDoctorFilter = (doctorName === 'all') ? null : doctorName;
        document.getElementById('doctor-filter-select').value = doctorName; 
        
        applyAllFiltersAndHighlight();
    }
    
    function handleHistoryImageClick(event) {
        event.stopPropagation(); 
        
        const imgElement = event.target;
        
        if (imgElement.tagName === 'IMG') {
            const fullSrc = imgElement.getAttribute('data-original-src') || imgElement.getAttribute('src'); 

            const modal = document.getElementById('imageModal');
            const fullImage = document.getElementById('fullImage');
            
            fullImage.src = fullSrc;
            modal.style.display = 'block';
        }
    }


    /* ================================================= */
    /* CKEDITOR & FORM LOGIC                             */
    /* ================================================= */
    
    function resizeImage(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = function(event) {
                const img = new Image();
                img.onload = function() {
                    let width = img.width;
                    let height = img.height;

                    if (width > MAX_WIDTH || height > MAX_HEIGHT) {
                        const ratio = Math.min(MAX_WIDTH / width, MAX_HEIGHT / height);
                        width *= ratio;
                        height *= ratio;
                    }

                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height); 

                    const thumbnailCanvas = document.createElement('canvas');
                    thumbnailCanvas.width = 150;
                    thumbnailCanvas.height = 100;
                    const thumbnailCtx = thumbnailCanvas.getContext('2d');
                    thumbnailCtx.drawImage(img, 0, 0, 150, 100);
                    
                    resolve({
                        default: canvas.toDataURL(file.type || 'image/png'), 
                        thumbnail: thumbnailCanvas.toDataURL(file.type || 'image/png')
                    });
                };
                img.onerror = function(e) {
                    reject('Error loading image.');
                };
                img.src = event.target.result;
            };
            reader.onerror = function() {
                reject('Could not read the file.');
            };
            reader.readAsDataURL(file);
        });
    }

    class MyUploadAdapter {
         constructor( loader ) {
            this.loader = loader;
        }

        upload() {
            return this.loader.file
                .then( file => {
                    return resizeImage(file)
                        .then( result => {
                            return { 
                                default: result.default 
                            };
                        })
                        .catch( error => {
                            throw error;
                        });
                });
        }

        abort() {
        }
    }

    function MyCustomUploadAdapterPlugin( editor ) {
        editor.plugins.get( 'FileRepository' ).createUploadAdapter = ( loader ) => {
            return new MyUploadAdapter( loader );
        };
    }
    
    ClassicEditor
        .create( document.querySelector( '#editor' ), {
            toolbar: {
                items: [
                    'bold', 'italic', 'underline', '|', 
                    'bulletedList', 'numberedList', '|',
                    'uploadImage',
                    'undo', 'redo'
                ]
            },
            extraPlugins: [ MyCustomUploadAdapterPlugin ],
            image: {
                toolbar: [ 'imageTextAlternative', '|', 'imageStyle:alignLeft', 'imageStyle:alignCenter', 'imageStyle:alignRight' ],
                styles: [ 'alignLeft', 'alignCenter', 'alignRight' ]
            },
            placeholder: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡πÄ‡∏°‡∏¥‡∏ô‡∏õ‡∏±‡∏ç‡∏´‡∏≤...',
        } )
        .then( editor => {
            console.log( 'CKEditor 5 is ready.', editor );
            editorInstance = editor; 
        } )
        .catch( error => {
            console.error( error );
        } );
        
    function copyToForm(recordElement) {
        const sections = ['subjective', 'objective', 'plan'];
        
        sections.forEach(section => {
            const historyItem = recordElement.querySelector(`.soap-history-item[data-section="${section}"]`);
            const formElement = document.getElementById(section);
            if (historyItem && formElement) {
                const dataText = JSON.parse(historyItem.getAttribute('data-text') || '{"value":""}').value; 
                formElement.value = dataText.trim();
            }
        });

        const assessmentItem = recordElement.querySelector('.soap-history-item[data-section="assessment"]');
        if (assessmentItem && editorInstance) {
            const dataHtml = JSON.parse(assessmentItem.getAttribute('data-html') || '{"value":""}').value; 
            
            if (dataHtml) {
                editorInstance.setData(dataHtml.trim());
            } else {
                 editorInstance.setData('');
            }
        }

        const noteContent = recordElement.querySelector('.note-history-content[data-section="note"]');
        const noteElement = document.getElementById('note');
        if (noteElement) {
             if (noteContent) {
                const dataText = JSON.parse(noteContent.getAttribute('data-text') || '{"value":""}').value; 
                noteElement.value = dataText.trim(); 
            } else {
                noteElement.value = ''; 
            }
        }
        
        document.querySelector('.soap-form-container').scrollTop = 0;

        alert('‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• SOAP ‡∏à‡∏≤‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Å‡πà‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
    }


    function toggleAttachmentInput() {
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡∏õ‡∏∏‡πà‡∏° 'Upload Image' ‡πÉ‡∏ô‡πÅ‡∏ñ‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏Ç‡∏≠‡∏á Assessment ‡πÅ‡∏ó‡∏ô‡∏Å‡∏≤‡∏£ Attach File ‡πÅ‡∏¢‡∏Å");
    }

    function toggleTag(element) {
        if (element.classList.contains('tag-yellow')) {
            element.classList.remove('tag-yellow');
            element.classList.add('tag-red');
        } else if (element.classList.contains('tag-red')) {
            element.classList.remove('tag-red');
        } else {
            element.classList.add('tag-yellow');
        }
    }
    
    function processAndSaveNote() {
        if (recognition && recognition.active) {
            recognition.stop();
        }
        saveNote(); 
    }
    
    function saveNote() {
        const s = document.getElementById('subjective').value.trim() || "N/A";
        const o = document.getElementById('objective').value.trim() || "N/A";
        
        let a = "N/A"; 
        let aHtml = "N/A"; 

        if (editorInstance) {
            aHtml = editorInstance.getData().trim();
            a = aHtml.replace(/<img.*?alt="(.*?)".*?>/g, (match, alt) => `[Image: ${alt || 'Attachment'}]`)
                     .replace(/<[^>]*>?/gm, ' ') 
                     .replace(/\s+/g, ' ')
                     .trim() || "N/A";
        } else {
            a = document.getElementById('editor').value.trim() || "N/A";
        }
        
        const p = document.getElementById('plan').value.trim() || "N/A";
        const note = document.getElementById('note').value.trim() || "N/A";
        
        const currentDate = new Date();
        const currentDateISO = currentDate.getFullYear() + '-' + String(currentDate.getMonth() + 1).padStart(2, '0') + '-' + String(currentDate.getDate()).padStart(2, '0');
        
        const timestamp = currentDate.toLocaleString('th-TH', { 
            day: '2-digit', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' 
        }).replace(/(\d{4})/, '$1').replace(',', '');
        
        const safeS = escapeForAttr(s);
        const safeO = escapeForAttr(o);
        const safeA = escapeForAttr(a);
        const safeAHtml = escapeForAttr(aHtml);
        const safeP = escapeForAttr(p);
        const safeNote = escapeForAttr(note);

        let noteHtml = '';

        if (note && note !== 'N/A') {
            noteHtml = `
                <div class="note-history-content" data-section="note" data-text='${safeNote}' data-original-text='${safeNote}'>
                    <strong>Note:</strong> <span>${note}</span>
                </div>
            `;
        }
        
        let assessmentContentHtml = '';
        if (aHtml === "N/A" || aHtml === "") {
            assessmentContentHtml = `<span>N/A</span>`;
        } else {
             const modifiedAHtml = aHtml.replace(/<img src="(.*?)"/g, (match, src) => {
                const fullSrc = src.replace(/640x450/g, '1280x900').replace(/150x100/g, '1280x900'); 
                const thumbSrc = src.replace(/640x450/g, '150x100').replace(/1280x900/g, '150x100'); 

                return `<img src="${thumbSrc}" data-original-src="${fullSrc}" style="float: left;" ondblclick="handleHistoryImageClick(event)"`;
             });
             
            assessmentContentHtml = `<div class="ck-content">${modifiedAHtml}</div>`;
        }
        
        const newNoteHtml = `
            <div class="note-record" data-date="${currentDateISO}" data-full-date="${currentDateISO}T${String(currentDate.getHours()).padStart(2, '0')}${String(currentDate.getMinutes()).padStart(2, '0')}" style="border-left: 5px solid #10b981; background-color: #f0fdf4; box-shadow: 0 6px 16px rgba(16, 185, 129, 0.2);" ondblclick="toggleTag(this)">
                <div class="note-record-header">
                    <button class="add-to-form-btn" onclick="copyToForm(this.closest('.note-record'))">
                        <i class="fa-solid fa-arrow-left"></i> Add
                    </button>
                    <span>${timestamp} (Just Saved)</span>
                    <span>‡∏ô‡∏û. ‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞ (You)</span>
                </div>
                <div class="soap-history-item" data-section="subjective" data-text='${safeS}' data-original-text='${safeS}'><strong>S:</strong> <span>${s}</span></div>
                <div class="soap-history-item" data-section="objective" data-text='${safeO}' data-original-text='${safeO}'><strong>O:</strong> <span>${o}</span></div>
                
                <div class="soap-history-item" data-section="assessment" 
                    data-text='${safeA}' 
                    data-html='${safeAHtml}' 
                    data-original-text='${safeA}' 
                    data-original-html='${safeAHtml}' >
                    <strong>A:</strong> 
                    ${assessmentContentHtml}
                </div>
                
                <div class="soap-history-item" data-section="plan" data-text='${safeP}' data-original-text='${safeP}'><strong>P:</strong> <span>${p}</span></div>
                ${noteHtml}
            </div>
        `;

        const historyContainer = document.getElementById('history-container');
        historyContainer.insertAdjacentHTML('afterbegin', newNoteHtml);
        
        // Clear form
        document.getElementById('subjective').value = '';
        document.getElementById('objective').value = '';
        if (editorInstance) editorInstance.setData(''); 
        document.getElementById('plan').value = '';
        document.getElementById('note').value = '';
        
        document.querySelector('.soap-form-container').scrollTop = 0;
        
        calculateTotalDays();
        
        document.getElementById('diagnosis-search-input').value = '';
        document.getElementById('doctor-filter-select').value = 'all'; 
        document.getElementById('image-only-switch').checked = false; 
        showImageOnly = false;
        
        const allBtn = document.querySelector('.date-filter-bar button[data-date-filter="all"]');
        if (allBtn) {
            filterHistoryByDate('all', allBtn); 
        }

        historyContainer.scrollTop = 0;
        
        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Progress Note ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß!");
    }
    
    function storeOriginalContent() {
        document.querySelectorAll('.note-record').forEach(record => {
            record.querySelectorAll('.soap-history-item, .note-history-content').forEach(item => {
                const isAssessment = item.getAttribute('data-section') === 'assessment';
                
                if (isAssessment) {
                    const dataHtmlAttr = item.getAttribute('data-html');
                    if (dataHtmlAttr) {
                        const originalHtml = JSON.parse(dataHtmlAttr).value;
                        item.setAttribute('data-original-html', escapeForAttr(originalHtml.trim()));
                    }

                } else {
                    const dataTextAttr = item.getAttribute('data-text');
                     if (dataTextAttr) {
                        const originalText = JSON.parse(dataTextAttr).value;
                        item.setAttribute('data-original-text', escapeForAttr(originalText.trim()));
                    }
                }
            });
        });
    }

    // --- FINAL INITIALIZATION BLOCK ---
    document.addEventListener('DOMContentLoaded', () => {
        // 1. Initial setup
        calculateTotalDays();
        storeOriginalContent(); 
        
        // FIX 2: Populate template select on load
        populateTemplateSelect(); 
        
        // 2. Event Listeners for Filters/Search 
        const searchInput = document.getElementById('diagnosis-search-input');
        if (searchInput) {
            searchInput.addEventListener('keyup', () => {
                applyAllFiltersAndHighlight(); 
            });
        }
        
        const doctorFilterSelect = document.getElementById('doctor-filter-select');
        if (doctorFilterSelect) {
            doctorFilterSelect.addEventListener('change', (e) => {
                filterHistoryByDoctor(e.target.value);
            });
        }
        
        // 3. Apply initial filters (should show all)
        applyAllFiltersAndHighlight(); 
        
        // Populate initial date filter bar
        document.getElementById('date-filter-bar').innerHTML = `
            <button data-date-filter="all" class="active" onclick="filterHistoryByDate('all', this)">All</button>
            <button data-date-filter="2025-11-27" onclick="filterHistoryByDate('2025-11-27', this)">27 ‡∏û.‡∏¢.</button>
            <button data-date-filter="2025-11-26" onclick="filterHistoryByDate('2025-11-26', this)">26 ‡∏û.‡∏¢.</button>
            <button data-date-filter="2025-11-25" onclick="filterHistoryByDate('2025-11-25', this)">25 ‡∏û.‡∏¢.</button>
            <button data-date-filter="2025-11-24" onclick="filterHistoryByDate('2025-11-24', this)">24 ‡∏û.‡∏¢.</button>
        `;
        
        // Populate initial doctor filter select
        document.getElementById('doctor-filter-select').innerHTML = `
            <option value="all">All Doctors</option>
            <option value="‡∏ô‡∏û. ‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞ (You)">‡∏ô‡∏û. ‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞ (You)</option>
            <option value="‡∏ô‡∏û. ‡∏û‡∏•‡∏±‡∏™">‡∏ô‡∏û. ‡∏û‡∏•‡∏±‡∏™</option>
            <option value="‡∏ô‡∏û. ‡∏Å‡∏±‡∏ç‡∏à‡∏ô‡πå">‡∏ô‡∏û. ‡∏Å‡∏±‡∏ç‡∏à‡∏ô‡πå</option>
            <option value="‡∏û‡∏ç. ‡∏ß‡∏¥‡πÑ‡∏•">‡∏û‡∏ç. ‡∏ß‡∏¥‡πÑ‡∏•</option>
        `;
    });

</script>

</body>
</html>